name: Update CVE Database

on:
  schedule:
    # Run every 6 hours: at 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 0,6,12,18 * * *'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force full database rebuild (5 years)'
        required: false
        type: boolean
        default: false
      days_lookback:
        description: 'Days to look back for incremental update'
        required: false
        type: number
        default: 7

permissions:
  contents: write

env:
  GO_VERSION: '1.24'
  DB_FILENAME: 'latest.db'

jobs:
  update-database:
    name: Update CVE Database
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ env.GO_VERSION }}-

      - name: Build nvd2sqlite tool
        run: go build -o bin/nvd2sqlite ./cmd/nvd2sqlite

      - name: Calculate date range
        id: dates
        run: |
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            # Full rebuild: 5 years ago
            START_DATE=$(date -u -d "5 years ago" +%Y-%m-%d)
          else
            # Incremental: use days_lookback or default 7 days
            DAYS=${{ inputs.days_lookback || 7 }}
            START_DATE=$(date -u -d "${DAYS} days ago" +%Y-%m-%d)
          fi
          END_DATE=$(date -u +%Y-%m-%d)

          echo "start_date=$START_DATE" >> $GITHUB_OUTPUT
          echo "end_date=$END_DATE" >> $GITHUB_OUTPUT
          echo "Date range: $START_DATE to $END_DATE"

      - name: Download CVEs from NVD
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          # Determine rate limit based on API key
          if [ -n "$NVD_API_KEY" ]; then
            RATE_LIMIT=50
            echo "Using NVD API key (rate limit: 50 req/30sec)"
          else
            RATE_LIMIT=5
            echo "No API key (rate limit: 5 req/30sec)"
          fi

          ./bin/nvd2sqlite \
            --output data/cve-db.sqlite \
            --start-date "${{ steps.dates.outputs.start_date }}" \
            --end-date "${{ steps.dates.outputs.end_date }}" \
            --rate-limit "$RATE_LIMIT" \
            --api-key "$NVD_API_KEY" \
            --verbose

      - name: Compress database and generate checksum
        run: |
          cd data

          # Get stats before compression
          CVE_COUNT=$(sqlite3 cve-db.sqlite "SELECT COUNT(*) FROM cves")
          DB_SIZE=$(du -h cve-db.sqlite | cut -f1)

          echo "CVE count: $CVE_COUNT"
          echo "Database size: $DB_SIZE"

          # Compress with gzip
          gzip -9 -k cve-db.sqlite
          mv cve-db.sqlite.gz ${{ env.DB_FILENAME }}.gz

          # Generate SHA256 checksum
          sha256sum ${{ env.DB_FILENAME }}.gz | awk '{print $1}' > ${{ env.DB_FILENAME }}.gz.sha256

          # Create metadata file
          cat > metadata.json << EOF
          {
            "version": "$(date -u +%Y.%m.%d.%H%M)",
            "last_modified": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "cve_count": $CVE_COUNT,
            "db_size_uncompressed": "$DB_SIZE",
            "checksum_sha256": "$(cat ${{ env.DB_FILENAME }}.gz.sha256)",
            "date_range_start": "${{ steps.dates.outputs.start_date }}",
            "date_range_end": "${{ steps.dates.outputs.end_date }}"
          }
          EOF

          # Cleanup uncompressed file
          rm -f cve-db.sqlite

          echo "=== Generated files ==="
          ls -la
          cat metadata.json

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet data/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected, will commit"
          fi

      - name: Commit and push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/
          git commit -m "chore: Update CVE database $(date -u +%Y-%m-%d)

          - CVEs: $(jq -r '.cve_count' data/metadata.json)
          - Date range: ${{ steps.dates.outputs.start_date }} to ${{ steps.dates.outputs.end_date }}
          - Size: $(jq -r '.db_size_uncompressed' data/metadata.json)

          [skip ci]"

          git push

  notify-on-failure:
    name: Notify on Failure
    needs: update-database
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const title = `CVE Database Update Failed - ${today}`;

            // Check for existing issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'cve-update-failure'
            });

            const existing = issues.data.find(i => i.title.includes(today));

            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body: `Another failure at ${new Date().toISOString()}\nRun: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: `## CVE Database Update Failed\n\n**Date**: ${today}\n**Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n### Possible Causes\n- NVD API rate limiting\n- NVD API maintenance\n- Network issues\n\n### Resolution\n1. Check workflow logs\n2. Verify NVD API status at https://nvd.nist.gov/\n3. Re-run manually if transient`,
                labels: ['cve-update-failure', 'automated']
              });
            }
