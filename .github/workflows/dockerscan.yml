name: DockerScan CI/CD

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v2.0.0)'
        required: true
        type: string

permissions:
  contents: write
  security-events: write

jobs:
  # Job 1: Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-1.22-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-1.22-
            ${{ runner.os }}-go-

      - name: Download dependencies
        working-directory: .
        run: go mod download

      - name: Run tests
        working-directory: .
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Display coverage
        working-directory: .
        run: go tool cover -func=coverage.out

      - name: Run go vet
        working-directory: .
        run: go vet ./...

      - name: Run staticcheck
        working-directory: .
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          staticcheck ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          fail_ci_if_error: false

  # Job 2: Build Multi-Platform Binaries
  build:
    name: Build Binaries
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Determine version
        id: get_version
        run: |
          VERSION="${{ inputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build for all platforms
        working-directory: .
        run: |
          mkdir -p bin

          echo "ðŸ”¨ Building for Linux amd64..."
          GOOS=linux GOARCH=amd64 go build -ldflags="-s -w -X github.com/cr0hn/dockerscan/v2/internal/config.Version=${{ steps.get_version.outputs.VERSION }}" \
            -o bin/dockerscan-linux-amd64 ./cmd/dockerscan

          echo "ðŸ”¨ Building for Linux arm64..."
          GOOS=linux GOARCH=arm64 go build -ldflags="-s -w -X github.com/cr0hn/dockerscan/v2/internal/config.Version=${{ steps.get_version.outputs.VERSION }}" \
            -o bin/dockerscan-linux-arm64 ./cmd/dockerscan

          echo "ðŸ”¨ Building for Linux 386..."
          GOOS=linux GOARCH=386 go build -ldflags="-s -w -X github.com/cr0hn/dockerscan/v2/internal/config.Version=${{ steps.get_version.outputs.VERSION }}" \
            -o bin/dockerscan-linux-386 ./cmd/dockerscan

          echo "ðŸ”¨ Building for macOS amd64 (Intel)..."
          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w -X github.com/cr0hn/dockerscan/v2/internal/config.Version=${{ steps.get_version.outputs.VERSION }}" \
            -o bin/dockerscan-darwin-amd64 ./cmd/dockerscan

          echo "ðŸ”¨ Building for macOS arm64 (Apple Silicon)..."
          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w -X github.com/cr0hn/dockerscan/v2/internal/config.Version=${{ steps.get_version.outputs.VERSION }}" \
            -o bin/dockerscan-darwin-arm64 ./cmd/dockerscan

          echo "ðŸ”¨ Building for Windows amd64..."
          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w -X github.com/cr0hn/dockerscan/v2/internal/config.Version=${{ steps.get_version.outputs.VERSION }}" \
            -o bin/dockerscan-windows-amd64.exe ./cmd/dockerscan

          echo "ðŸ”¨ Building for Windows arm64..."
          GOOS=windows GOARCH=arm64 go build -ldflags="-s -w -X github.com/cr0hn/dockerscan/v2/internal/config.Version=${{ steps.get_version.outputs.VERSION }}" \
            -o bin/dockerscan-windows-arm64.exe ./cmd/dockerscan

          echo "ðŸ”¨ Building for Windows 386..."
          GOOS=windows GOARCH=386 go build -ldflags="-s -w -X github.com/cr0hn/dockerscan/v2/internal/config.Version=${{ steps.get_version.outputs.VERSION }}" \
            -o bin/dockerscan-windows-386.exe ./cmd/dockerscan

          echo "ðŸ”¨ Building for FreeBSD amd64..."
          GOOS=freebsd GOARCH=amd64 go build -ldflags="-s -w -X github.com/cr0hn/dockerscan/v2/internal/config.Version=${{ steps.get_version.outputs.VERSION }}" \
            -o bin/dockerscan-freebsd-amd64 ./cmd/dockerscan

          echo "âœ… All builds completed!"
          ls -lh bin/

      - name: Generate checksums
        working-directory: ./bin
        run: |
          echo "ðŸ“ Generating SHA256 checksums..."
          sha256sum dockerscan-* > checksums.txt
          echo "âœ… Checksums generated:"
          cat checksums.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dockerscan-binaries-${{ steps.get_version.outputs.VERSION }}
          path: bin/
          retention-days: 30

  # Job 3: Create Release
  release:
    name: Create GitHub Release
    needs: [test, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dockerscan-binaries-${{ inputs.version }}
          path: bin/

      - name: Create release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## ðŸ‹ðŸ”’ DockerScan ${{ inputs.version }}

          ### The Most Comprehensive Docker Security Scanner

          **By [Daniel Garcia (cr0hn)](https://cr0hn.com)**

          ---

          ### ðŸŽ¯ What's Included

          This release includes pre-compiled binaries for:

          - **Linux**: amd64, arm64, 386
          - **macOS**: amd64 (Intel), arm64 (Apple Silicon)
          - **Windows**: amd64, arm64, 386
          - **FreeBSD**: amd64

          ### ðŸš€ Quick Start

          #### Linux / macOS
          ```bash
          # Download (replace with your platform)
          curl -L https://github.com/cr0hn/dockerscan/releases/download/${{ inputs.version }}/dockerscan-linux-amd64 -o dockerscan

          # Verify checksum (recommended)
          curl -L https://github.com/cr0hn/dockerscan/releases/download/${{ inputs.version }}/checksums.txt -o checksums.txt
          sha256sum -c checksums.txt --ignore-missing

          # Make executable and install
          chmod +x dockerscan
          sudo mv dockerscan /usr/local/bin/

          # Run
          dockerscan nginx:latest
          ```

          #### Windows (PowerShell)
          ```powershell
          Invoke-WebRequest -Uri "https://github.com/cr0hn/dockerscan/releases/download/${{ inputs.version }}/dockerscan-windows-amd64.exe" -OutFile "dockerscan.exe"
          .\dockerscan.exe nginx:latest
          ```

          ### ðŸŒŸ Features

          âœ… **CIS Docker Benchmark v1.7.0** - 80+ automated compliance checks
          âœ… **Supply Chain Attack Detection** - Based on 2024-2025 research
          âœ… **Advanced Secrets Detection** - 40+ secret patterns (AWS, GCP, Azure, API keys, etc.)
          âœ… **CVE Scanning** - Critical 2024-2025 vulnerabilities
          âœ… **Runtime Security** - Linux capabilities, Seccomp, AppArmor, namespace analysis
          âœ… **SARIF Output** - GitHub Security, Azure DevOps, VS Code integration
          âœ… **JSON Reports** - Machine-readable format
          âœ… **Beautiful CLI** - Color-coded severity levels

          ### ðŸ“Š Security Coverage

          - **CIS Benchmark**: Host config, daemon hardening, image best practices, runtime security
          - **Supply Chain**: Imageless containers, crypto miners, backdoored libs, signature verification
          - **Secrets**: Cloud credentials, API keys, private keys, JWT tokens, DB connections
          - **CVEs**: CVE-2024-21626, CVE-2024-23651/52/53, CVE-2024-8695/96, CVE-2025-9074
          - **Runtime**: Capabilities audit, Seccomp profiles, container escape detection

          ### ðŸ” Example Usage

          ```bash
          # Basic scan
          dockerscan nginx:latest

          # Specific scanners
          dockerscan --scanners cis,secrets,vulnerabilities myapp:v1.0

          # CI/CD integration
          dockerscan myapp:latest
          if [ $? -eq 2 ]; then
            echo "Critical vulnerabilities found!"
            exit 1
          fi
          ```

          ### ðŸ“š Documentation

          - [README](https://github.com/cr0hn/dockerscan/blob/main/README.md) - Complete documentation
          - [Use Cases](https://github.com/cr0hn/dockerscan/blob/main/README.md#-use-cases) - CI/CD, audits, compliance
          - [Architecture](https://github.com/cr0hn/dockerscan/blob/main/README.md#-architecture) - Extensibility guide

          ### ðŸ› Bug Reports & Feature Requests

          Please report issues at: https://github.com/cr0hn/dockerscan/issues

          ### ðŸ“„ License

          BSD-3-Clause License

          ### ðŸ‘¤ Author

          **Daniel Garcia (cr0hn)**
          - Website: https://cr0hn.com
          - GitHub: https://github.com/cr0hn
          - Twitter: @ggdaniel

          ---

          **â­ If you find DockerScan useful, please star the repository!**

          *Making Docker Security Accessible to Everyone*
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version }}
          name: DockerScan ${{ inputs.version }}
          body_path: RELEASE_NOTES.md
          files: |
            bin/dockerscan-*
            bin/checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest tag
        run: |
          git tag -f latest
          git push -f origin latest

  # Summary Job
  summary:
    name: Workflow Summary
    if: always()
    needs: [test, build, release]
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ‹ DockerScan CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**By Daniel Garcia (cr0hn)** | https://cr0hn.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Workflow Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ needs.release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ‰ Release Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download**: https://github.com/cr0hn/dockerscan/releases/tag/${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*DockerScan - Making Docker Security Accessible to Everyone*" >> $GITHUB_STEP_SUMMARY
